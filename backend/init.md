叙事镜（Narrative Mirror）
产品与技术完整文档 V6.0
2026年2月 · 澄清修订版
本版本相对 V5.1 的核心修订
明确树的通用性：树在构建期不预设任何叙事主题，专题化发生在查询侧；
补全查询侧完整设计（V5.1 完全缺失）；
修正 Layer 2 相似度阈值策略（两阶段判断，不再用硬门槛 0.75）；
说明后台构建机制（非阻塞用户主流程）；
提供从原始消息到最终输出的完整 Demo Case。
1. 产品本质：一句话说清楚
我们做的事只有一件：
核心定义
完全在用户本地设备上运行，把几年甚至十几年的微信聊天记录，自动理解并重建为一条"故事线"——用户问"我和TA是怎么一步步分手的？"或"我入职后工作进展如何？"，系统就输出清晰的4-8个阶段，每个阶段都有标题、时间范围、核心结论、3-5条原始消息铁证、透明推理链、不确定性说明。用户可以随意编辑，最终导出"我的最终版本"。
这不是摘要，不是关键词搜索，不是 RAG 片段检索，而是把散乱的"经历"变成可读、可追溯、可修改的叙事弧线。数据100%不离开设备，AI 只提供"建议骨架+铁证"，最终作者永远是用户自己。
2. 系统架构总览：构建期 vs 查询期
系统由两个完全分离的阶段组成。这种分离是整个系统效率的根本来源：把重计算放在构建期（一次性），查询期只做"查表+遍历+翻译"。
Table
Copy
维度	构建期（一次性，后台运行）	查询期（每次提问触发）
目标	把所有消息变成结构化树，物化所有可能有用的信号	根据用户问题，从树里提取专属子树，翻译成人话
主题预设	无。树完全不知道用户将来会问什么	有。由 Q1 意图解析决定捞哪些维度的信号
耗时	120万条消息首次约 2-4 小时，后台静默，不阻塞用户	秒级~分钟级（重计算已在构建期完成）
存储	SQLite（节点数据）+ LanceDB（向量索引）	只读取，不写入（除用户编辑外）
3. 构建期：把消息变成树（三层结构）
关键原则：树不预设主题
树在构建期完全不知道用户将来会问【分手】还是【工作进展】还是【我们什么时候开始闹矛盾的】。它只做一件事：忠实记录「发生了什么、什么时候发生的、模式怎么变化了」。专题化（恋爱/工作/家庭）发生在查询期的 Q1 意图解析阶段，不在这里。
3.1 Layer 1：时序核心树（节点构建）
构建步骤（由本地小模型完成，全程后台，不阻塞用户）：
预处理：解析微信 SQLite → 所有消息按时间戳严格排序 → Burst 聚合（连续消息间隔 < 30 分钟为一个 Burst，保留每条原始 msg_id）。
从第一个 Burst 开始，创建初始 TopicNode。
对当前 Burst 里每一条消息，模型顺序判断：
是否延续当前话题？
是否出现话题切换或混合？
是否出现旧话题回归或情绪突变？
决策：延续则追加；混合则在 Burst 内部实时拆分子节点（最多 4 个）；切换则结束当前节点、创建新兄弟节点，若为旧话题回归则添加 continuation_pointer。
3.2 Layer 1.5：互动元数据层（通用信号物化）
每创建一个节点时，同步计算并写入以下通用元数据。这些信号在恋爱、工作、家庭等所有场景中均有意义：
Table
Copy
信号类型	在恋爱场景中的意义	在工作场景中的意义
reply_delay（回复延迟）	亲密度变化信号	工作参与度/忙碌度变化
term_shift（称呼/措辞漂移）	感情温度变化	汇报方式从被动→主动
silence_event（沉默事件）	关系仪式消失	项目停滞或关系疏远
topic_frequency（话题频率）	某类话题被回避	工作话题增多/减少趋势
initiator_ratio（主被动发起比）	谁更主动维系关系	谁在推进工作/汇报
emotional_tone（情绪基调）	关系整体氛围	工作压力/积极性变化
conflict_intensity（冲突强度）	争吵升级程度	分歧严重度
异常事件（数值超出该对话历史均值 2 个标准差）自动写入异常锚点表（Anomaly Anchor Table），供查询期秒级定位。
3.3 Layer 2：语义话题线程（修订版两阶段策略）
V5.1 使用固定 0.75 相似度阈值作为硬门槛，存在两个问题：
同一主题跨越时间后措辞差异大，embedding 距离可能远低于 0.75；
而不相关话题（如「今天吃火锅」和「明天吃火锅」）相似度可能超过 0.75，但毫无叙事关联。
修订后策略：两阶段判断
第一阶段：embedding 相似度仅做候选召回（门槛放宽至 0.5），拿到候选节点对后进入第二阶段。
第二阶段：由 LLM 做最终语义裁定——「这两个节点是否属于同一个演化故事？」只有 LLM 确认后才建立指针。
结果：召回率和精确率同时提升，不再依赖一个拍脑袋给出的数字。
3.4 后台构建机制：为什么不会卡住用户
类比：手机相册
你拍完 100 张照片，手机不会让你站着等它做完人脸识别、场景分类再还给你。它先给你看缩略图（秒级），然后后台慢慢处理。
我们的系统完全相同：
导入完成 → 用户立刻可以看到原始时间线（秒级）
后台静默跑树构建（可关机，下次打开继续）
某个对话的树建完 → 旁边出现「✓ 可深度查询」标记
用户才能对它提问
小模型跑得慢不是问题，问题是不能让它阻塞用户主流程。后台构建就是解决这个问题的，仅此而已。
4. 查询期：从提问到叙事输出（完整设计，V5.1 缺失部分）
查询期分为五个阶段。核心设计原则：重计算已在构建期完成，查询期只做"查表 + 遍历 + 翻译"。
Q1：查询意图解析
用户输入进来，本地 32B 模型做意图分类，输出结构化查询描述。这一步决定了后续去捞树上哪些维度的信号，是整个查询侧专题化的唯一入口。同一棵树，不同问题，Q1 输出完全不同：
Table
Copy
用户问题	query_type	focus_dimensions（去树里捞什么）
我们是怎么一步步分手的？	arc_narrative	intimacy_decay, conflict_escalation, silence_pattern
我入职后工作进展如何？	arc_narrative	work_topic, skill_growth, task_complexity, initiator_ratio
我和老板的交流情况怎样？	arc_narrative	work_topic, reply_delay（老板侧）, emotional_tone
2023年6月发生了什么？	time_point	all_signals, time_range=2023-06
我们第一次吵架是什么时候？	event_retrieval	conflict_peak, conflict_intensity
Q2：元数据层优先扫描（秒级定位异常锚点）
拿到意图描述后，不直接拉原始节点，而是先查异常锚点表，用 focus_dimensions 精确匹配，秒级返回 4-8 个锚点节点 ID。速度来源于构建期已经把所有信号物化——查询期只是查一张结构化表。
Q3：Layer 2 线程遍历，组装候选节点池
拿到锚点节点 ID 后，沿 Layer 2 指针网络向前向后扩展，把每个锚点所在的"话题演化线程"完整拉出来，按时间排序，形成候选节点池（通常 40-80 个节点）。节点内容只含摘要和元数据，不含完整原文，供下一步大模型推理。
Q4：32B 模型弧线分段 + 证据验证循环
把候选节点池打包送给本地 32B 模型：
将节点分为 4-6 个叙事阶段
为每个阶段选 3-5 条代表性原始 msg_id 作为证据
写核心结论
写不确定性说明
模型返回草案后，系统执行证据验证循环：取出被引用的 msg_id 原文，检查时间戳是否真实落在对应阶段范围内。不一致则打回重来（最多 2 次）。通过后才进入输出阶段。
Q5：输出可编辑叙事卡片
每张卡片结构固定：
阶段标题
时间范围（附 msg_id 范围）
核心结论
3-5 条原文证据（点击跳转）
推理链
不确定性声明
编辑控件（改标题、删/加证据、拖拽排序、标「不认同此解读」）
5. 完整 Demo Case：从原始消息到叙事输出
以下用 20 条消息走完完整闭环，展示构建期如何建树、查询期如何从树提取结果。整个流程说明树是通用的：同样的构建产物，换一个问题就输出完全不同的叙事。
5.1 原始微信聊天记录输入
plain
Copy
msg_001 2023.03.10 22:10 你："今天好累，被老板骂了一顿"
msg_002 2023.03.10 22:11 TA："宝贝！怎么了，说来听听"
msg_003 2023.03.10 22:35 你："就说我报告数据不对，其实是他自己改了需求"
msg_004 2023.03.10 22:36 TA："气死我了！你已经很厉害了，不用理他"
msg_005 2023.03.10 22:37 TA："周末去吃你最喜欢的火锅？"
msg_006 2023.03.10 22:38 你："好呀好呀！爱你"
msg_007 2023.03.10 23:01 TA："晚安宝贝❤"
msg_008 2023.03.10 23:02 你："晚安❤"

msg_009 2023.06.05 23:41 你："今天老板又骂我了，一整天都在加班"
msg_010 2023.06.06 02:43 TA："哦" ← 3小时后回复
msg_011 2023.06.06 09:15 你："你昨晚睡了？"
msg_012 2023.06.06 09:20 TA："嗯，困了"

msg_013 2023.09.15 20:00 你："你最近是不是不想理我"
msg_014 2023.09.15 20:05 TA："没有，就是最近压力大"
msg_015 2023.09.15 20:06 你："你压力大我理解，但你有没有想过我也需要你"
msg_016 2023.09.15 20:15 TA："好了好了，我知道了" ← 9分钟沉默后
msg_017 2023.09.15 20:16 你："你能不能好好说话"
msg_018 2023.09.15 20:17 TA："我真的很累" ← 之后24h无消息

msg_019 2023.12.20 23:55 你："晚安" ← TA无回复
msg_020 2024.02.14 21:00 你："我们谈谈吧"
5.2 构建期：Layer 1 节点生成
Burst A：2023.03.10 22:10-23:02（msg_001-008）
小模型在22:37检测到话题切换（工作吐槽 → 约会计划）
实时拆分为两个子节点：
Node_A1（工作压力-老板批评）：msg_001-004
Node_A2（生活亲密-约会晚安）：msg_005-008
Node_A2.causal_link → Node_A1
Burst B：2023.06.05 23:41-06.06 09:20（msg_009-012）
单一话题，不拆分
Node_B（工作压力-老板批评）：msg_009-012
Burst C：2023.09.15 20:00-20:17（msg_013-018）
单一冲突话题，不拆分
Node_C（情感需求冲突）：msg_013-018
Burst D：msg_019（独立节点）
Burst E：msg_020（独立节点）
5.3 构建期：Layer 1.5 元数据写入
Node_A1 元数据：
reply_delay: <1min（正常）
term_by_TA: 宝贝（亲昵词）
无异常
Node_B 元数据：
reply_delay: 3h02min（⚠️ 增加18倍）
term_by_TA: 哦（⚠️ 回避词首现）
写入异常锚点表：
{type:reply_delay_surge, node:B, date:2023-06-05}
{type:avoidance_word_first, node:B, date:2023-06-06}
Node_C 元数据：
conflict_intensity: 0.88（高）
post_burst_silence: 24h（⚠️）
写入异常锚点表：{type:conflict_peak, node:C, date:2023-09-15}
Node_D（msg_019）元数据：
对比Node_A2建立的「晚安仪式」基线：TA回复率历史100%，今日0
写入异常锚点表：{type:ritual_silence, node:D, date:2023-12-20}
5.4 构建期：Layer 2 指针建立（两阶段）
第一阶段：embedding 召回（门槛 0.5）
Table
Copy
节点对	内容相似度	结果
Node_A1 ↔ Node_B	工作被批评，相似度 0.81	进入第二阶段
Node_A2 ↔ Node_C	话题不同，相似度 0.31	过滤
Node_A2 ↔ Node_D	均含晚安，相似度 0.73	进入第二阶段
第二阶段：LLM 语义裁定
Node_A1 → Node_B：「TA回应方式从支持变为冷漠，属于同一演化故事」✓
Node_A2 → Node_D：「从每日晚安到晚安无回复，亲密仪式衰减同一故事」✓
Node_C → Node_D：「冲突后仪式消失，有因果关联」✓
最终线程：
【工作压力演化线程】：Node_A1 → Node_B
【亲密行为衰减线程】：Node_A2 → Node_C → Node_D → Node_E
5.5 查询期：用户问「我们是怎么一步步分手的？」
Q1 意图解析输出：
query_type: arc_narrative
focus_dimensions: [intimacy_decay, conflict_escalation, silence_pattern]
Q2 异常锚点表查询结果（命中4个）：
Node_B → reply_delay_surge + avoidance_word_first
Node_C → conflict_peak
Node_D → ritual_silence
Node_E → 分手信号
Q3 候选节点池（沿线程扩展）：
亲密衰减线程：Node_A2, Node_C, Node_D, Node_E
工作压力线程：Node_A1, Node_B
共 6 个节点，20 条 msg_id
Q4 32B模型分段草案 → 证据验证（全部通过）：
阶段1 热恋期（2023.03） → 证据：msg_001-008
阶段2 第一道裂痕（2023.06） → 证据：msg_009, 010, 012
阶段3 冲突激化（2023.09） → 证据：msg_013, 015, 016, 018
阶段4 仪式消失与终点（2023.12-2024.02）→ 证据：msg_019, 020
5.6 最终输出：用户看到的叙事卡片（示例2张）
阶段1：热恋期 | 2023年3月 | msg_001 ~ msg_008
核心结论：关系处于高能量状态。TA 反应迅速（回复延迟 < 1分钟），使用亲昵称呼，主动提供情感支持，每天维持晚安仪式。
关键证据（点击跳转原文）：
2023.03.10 22:11 TA："宝贝！怎么了，说来听听"
2023.03.10 22:37 TA："周末去吃你最喜欢的火锅？"
2023.03.10 23:01 TA："晚安宝贝❤"
推理链：回复延迟 < 1min + 亲昵称呼 + 主动安慰 + 约会提议 → 情感投入度高，亲密仪式稳定。
不确定性：仅有 1 天数据，不排除这是特殊好日子，不代表整体水平。
[编辑] [不认同此解读]
阶段2：第一道裂痕 | 2023年6月 | msg_009 ~ msg_012
核心结论：同样是工作被批评，TA 回复延迟从 < 1分钟增至 3小时2分钟（增加18倍），称呼从"宝贝"消失，首次出现"哦"等单字回避词，情感支持质量骤降。
关键证据（点击跳转原文）：
2023.06.05 23:41 你："今天老板又骂我了，一整天都在加班"
2023.06.06 02:43 TA："哦" ← 3小时2分钟后
2023.06.06 09:20 TA："嗯，困了"
推理链：回复延迟增加18倍 + 首次回避词「哦」+ 无情感内容 → 对比阶段1，亲密互动模式首次发生结构性变化。
不确定性：也可能 TA 当晚真的早睡了。但「哦」作为唯一回复，在情感表达上仍明显低于此前水平。
[编辑] [不认同此解读]
6. 查询通用性：同一棵树回答不同问题
这是 V5.1 最大的误导性遗漏。整个 Demo Case 看起来专门为恋爱关系设计，但树本身对话题完全无知。
如果用户问的不是"分手"，而是"我入职后工作进展如何"，Q1 输出的 focus_dimensions 完全不同，系统去捞的是：
work_topic 频率变化
question_frequency 下降（从多问变少问 = 上手了）
task_ownership 首现（「我来负责」类表述）
initiator_ratio 变化（从被动接任务到主动汇报）
最终输出的阶段就会变成：
阶段1：摸索期（入职前两个月）
你频繁发问，消息里大量出现「这个怎么弄」「我不确定」
老板回复详细，逐条解释
阶段2：上手期（第3-4个月）
你主动汇报增多，老板回复变短（不再需要解释细节）
提问频率下降约70%
阶段3：独立承担期（第5个月至今）
出现「我来负责这块」类表述（task_ownership 首次出现）
老板开始转发任务给你而非指派
树完全没有变，变的只是 Q1 告诉系统去捞哪些维度的信号。这是构建期与查询期分离设计的核心价值。
7. 开发与上线路径
Table
Copy
阶段	时间	交付物
阶段1	Month 1-2	微信解析 + Layer 1 + Layer 1.5 + 后台构建机制 + 可用时间线视图
阶段2	Month 3-4	Layer 2 指针（两阶段策略）+ Q1-Q5 查询侧完整实现 + 用户编辑界面 + 安全护栏
阶段3	Month 5-6	增量更新 + Personal Lexicon + 开源（GitHub 首个本地叙事重建工具）
阶段4	v2	跨窗口全局关系图谱 + 轻量 VLM（图片/语音消息理解）
8. 核心承诺
AI 只提供带铁证的建议，你才是故事的最终作者。
系统承认聊天极度复杂，用最小工程代价覆盖最高频痛点，把剩余部分交给「用户可编辑」这个最强大的人性化机制。
数据 100% 不离开设备。没有云端上传，没有模型训练，没有广告。